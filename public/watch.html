<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ZapFix â€” Watch</title>
  <style>
    :root{ --sky:#E0F3FF; --blue:#0077ff; --green:#00b894; --white:#ffffff; }
    *{box-sizing:border-box}
    body{ margin:0; font-family:'Poppins',sans-serif; background:var(--sky); color:#222; }
    header{ display:flex; align-items:center; justify-content:space-between; padding:15px 20px; background:var(--white); box-shadow:0 2px 8px rgba(0,0,0,0.08); position:sticky; top:0; z-index:100; }
    .logo{ font-size:24px; font-weight:700; color:var(--blue); cursor:pointer; }
    main{ display:grid; grid-template-columns: 2fr 1fr; gap:22px; padding:26px; max-width:1200px; margin:0 auto; }
    .video-section{ background:var(--white); border-radius:14px; padding:14px; box-shadow:0 6px 20px rgba(0,0,0,0.06); }
    video{ width:100%; border-radius:12px; }
    .video-title{ font-size:1.4rem; font-weight:600; margin:12px 0 8px; }
    .video-desc{ color:#555; line-height:1.6; }
    .actions{ display:flex; gap:12px; margin:15px 0; }
    .btn{ padding:8px 16px; border-radius:10px; cursor:pointer; font-weight:600; }
    .like-btn{ background:#f0f0f0; color:#333; }
    .share-btn{ background:var(--blue); color:white; }
    .comments{ margin-top:20px; }
    .comment-form{ display:flex; gap:8px; margin-bottom:15px; }
    .comment-form input{ flex:1; padding:10px; border:1px solid #ddd; border-radius:8px; }
    .comment-form button{ background:var(--green); color:white; border:none; padding:10px 16px; border-radius:8px; }
    .comment{ background:#f9f9f9; padding:10px; border-radius:8px; margin:8px 0; }
  </style>
</head>
<body>
<header>
  <div class="logo" onclick="location.href='feed.html'">ZAPFIX</div>
</header>

<main>
  <div class="video-section">
    <video id="videoPlayer" controls></video>
    <h2 class="video-title" id="videoTitle"></h2>
    <p class="video-desc" id="videoDesc"></p>
    <div class="actions">
      <button class="btn like-btn" id="likeBtn">Like (<span id="likeCount">0</span>)</button>
      <button class="btn share-btn" id="shareBtn">Share</button>
    </div>
    <div class="comments">
      <h3>Comments</h3>
      <div class="comment-form">
        <input type="text" id="commentName" placeholder="Your name">
        <input type="text" id="commentText" placeholder="Add comment">
        <button id="addComment">Post</button>
      </div>
      <div id="commentsList"></div>
    </div>
  </div>
</main>

<script>
const urlParams = new URLSearchParams(location.search);
const videoId = urlParams.get('id');
if (!videoId) location.href = 'feed.html';

let currentVideo = null;

async function loadVideo() {
  try {
    const res = await fetch('/videos');
    const data = await res.json();
    currentVideo = data.videos.find(v => v._id === videoId);
    if (!currentVideo) throw new Error('Video not found');

    document.getElementById('videoPlayer').src = currentVideo.file;
    document.getElementById('videoTitle').textContent = currentVideo.name;
    document.getElementById('videoDesc').textContent = currentVideo.description;
    document.getElementById('likeCount').textContent = currentVideo.likes || 0;
    renderComments();
  } catch (err) {
    alert('Failed to load video');
  }
}

function renderComments() {
  const list = document.getElementById('commentsList');
  list.innerHTML = '';
  (currentVideo.comments || []).forEach(c => {
    const div = document.createElement('div');
    div.className = 'comment';
    div.innerHTML = `<strong>${c.name}</strong>: ${c.text}`;
    list.appendChild(div);
  });
}

document.getElementById('addComment').addEventListener('click', async () => {
  const name = document.getElementById('commentName').value.trim();
  const text = document.getElementById('commentText').value.trim();
  if (!name || !text) return;

  try {
    await fetch(`/api/tools/${videoId}/comment`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, text })
    });
    loadVideo();
    document.getElementById('commentName').value = '';
    document.getElementById('commentText').value = '';
  } catch (err) {
    alert('Comment failed');
  }
});

document.getElementById('likeBtn').addEventListener('click', async () => {
  try {
    const res = await fetch(`/api/tools/${videoId}/like`, { method: 'POST' });
    const data = await res.json();
    document.getElementById('likeCount').textContent = data.likes;
  } catch (err) {
    alert('Like failed');
  }
});

document.getElementById('shareBtn').addEventListener('click', () => {
  if (navigator.share) {
    navigator.share({ title: currentVideo.name, url: location.href });
  } else {
    navigator.clipboard.writeText(location.href);
    alert('Link copied!');
  }
});

loadVideo();
</script>
</body>
</html>